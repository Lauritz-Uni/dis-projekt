{% extends "base.html" %}
{% block title %}Search Results{% endblock %}

{% block content %}
<h1>Search Results for "{{ query }}"</h1>

{% if movies %}
<div class="row">
  {% for movie in movies %}
  <div class="col-md-4 mb-4">
    <div class="card" data-title="{{ movie.title }}">
      <img class="card-img-top poster" src="{{ movie.poster }}" alt="{{ movie.title }}">
      <div class="card-body">
        <h5 class="card-title">{{ movie.title }}</h5>
        <p class="card-text">Rotten Tomatoes: {{ movie.tomato_meter }}% 
          <br> Audience Score: {{ movie.audience_score }}%
          {% if movie.genre %}
          <br> Genre{{ "s" if movie.genre.split(", ") | length > 1 else "" }}: {{ movie.genre }}
          {% else %}
          <br> Genre: N/A
          {% endif %}</p></p>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<p>No movies found matching your search.</p>
{% endif %}

<nav aria-label="Search pagination">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('views.search', q=query, page=page-1) }}">Previous</a>
    </li>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('views.search', q=query, page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
    {% if page < total_pages %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('views.search', q=query, page=page+1) }}">Next</a>
    </li>
    {% endif %}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.card').forEach(function (card) {
    const title = card.dataset.title;
    const img = card.querySelector('.poster');

    fetch(`/poster/${encodeURIComponent(title)}`)
      .then(res => res.json())
      .then(data => {
        if (data.poster) {
          img.src = data.poster;
        }
      })
      .catch(error => {
        console.error('Error fetching poster:', error);
      });
  });
});
</script>
{% endblock %}
