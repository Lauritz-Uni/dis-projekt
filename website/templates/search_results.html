{% extends "base.html" %}
{% block title %}Search Results{% endblock %}

{% block content %}
<div class="row">
  <!-- Left Sidebar Filters -->
  <div class="col-md-3">
    <form method="get" action="{{ url_for('views.search') }}">

      <div class="form-group">
        <label for="q">Title</label>
        <input type="text" class="form-control" name="q" placeholder="Title" value="{{ query or '' }}">
      </div>

      <div class="form-group">
        <label for="genre">Genre</label>
        <select class="form-control" name="genre">
          <option value="">All Genres</option>
          {% for g in genres %}
            <option value="{{ g }}" {% if genre == g %}selected{% endif %}>{{ g }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="rating">Rating</label>
        <select class="form-control" name="rating">
          <option value="">All Ratings</option>
          {% for r in ratings %}
            <option value="{{ r }}" {% if rating == r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="language">Language</label>
        <select class="form-control" name="original_language">
          <option value="">All Languages</option>
          {% for lang in languages %}
            <option value="{{ lang }}" {% if original_language == lang %}selected{% endif %}>{{ lang }}</option>
          {% endfor %}
        </select>
      </div>


      <div class="form-group">
        <label for="grade">Grade Reviews</label>
        <select class="form-control" name="grade">
          <option value="" {% if grade == '' %}selected{% endif %}>All Grades</option>
          <option value="A+" {% if grade == 'A+' %}selected{% endif %}>A+</option>
          <option value="A" {% if grade == 'A' %}selected{% endif %}>A</option>
          <option value="A-" {% if grade == 'A-' %}selected{% endif %}>A-</option>
          <option value="B+" {% if grade == 'B+' %}selected{% endif %}>B+</option>
          <option value="B" {% if grade == 'B' %}selected{% endif %}>B</option>
          <option value="B-" {% if grade == 'B-' %}selected{% endif %}>B-</option>
          <option value="C+" {% if grade == 'C+' %}selected{% endif %}>C+</option>
          <option value="C" {% if grade == 'C' %}selected{% endif %}>C</option>
          <option value="C-" {% if grade == 'C-' %}selected{% endif %}>C-</option>
          <option value="D" {% if grade == 'D' %}selected{% endif %}>D</option>
          <option value="F" {% if grade == 'F' %}selected{% endif %}>F</option>
          <option value="F---" {% if grade == 'F---' %}selected{% endif %}>F---</option>
          <option value="ZERO STARS" {% if grade == 'ZERO STARS' %}selected{% endif %}>ZERO STARS</option>
          <option value="ONE STAR" {% if grade == 'ONE STAR' %}selected{% endif %}>ONE STAR</option>
          <option value="TWO STARS" {% if grade == 'TWO STARS' %}selected{% endif %}>TWO STARS</option>
          <option value="THREE STARS" {% if grade == 'THREE STARS' %}selected{% endif %}>THREE STARS</option>
          <option value="FOUR STARS" {% if grade == 'FOUR STARS' %}selected{% endif %}>FOUR STARS</option>
          <option value="FIVE STARS" {% if grade == 'FIVE STARS' %}selected{% endif %}>FIVE STARS</option>
        </select>
      </div>

      <div class="form-group">
        <label>Tomato Meter</label>
        <input type="range" name="min_score" min="0" max="100" value="{{ min_score or 0 }}" oninput="document.getElementById('minOut').textContent = this.value">
        Min: <span id="minOut">{{ min_score or 0 }}</span>%
        <br>
        <input type="range" name="max_score" min="0" max="100" value="{{ max_score or 100 }}" oninput="document.getElementById('maxOut').textContent = this.value">
        Max: <span id="maxOut">{{ max_score or 100 }}</span>%
      </div>

      <div class="form-group">
        <label>Runtime (minutes)</label>
        <input type="range" name="min_runtime" min="0" max="360" value="{{ min_runtime or 0 }}" oninput="document.getElementById('minRuntimeOut').textContent = this.value">
        Min: <span id="minRuntimeOut">{{ min_runtime or 0 }}</span> min
        <br>
        <input type="range" name="max_runtime" min="0" max="360" value="{{ max_runtime or 360 }}" oninput="document.getElementById('maxRuntimeOut').textContent = this.value">
        Max: <span id="maxRuntimeOut">{{ max_runtime or 300 }}</span> min
      </div>

      <div class="form-group">
        <label for="min_critic">Critic Score</label> <br>
        <input type="range" name="min_critic" min="0" max="100" value="{{ min_critic or 0 }}" 
              oninput="document.getElementById('minCriticOut').textContent = this.value">
        Min: <span id="minCriticOut">{{ min_critic or 0 }}</span>%

        <br>
    
        <input type="range" name="max_critic" min="0" max="100" value="{{ max_critic or 100 }}" 
              oninput="document.getElementById('maxCriticOut').textContent = this.value">
        Max: <span id="maxCriticOut">{{ max_critic or 100 }}</span>%
      </div>

      <div class="form-group">
        <label>Release Year (Theaters)</label>
        <input type="range" name="min_year_theaters" min="1900" max="2025" value="{{ min_year_theaters or 1900 }}" oninput="document.getElementById('minYearTheatersOut').textContent = this.value">
        Min: <span id="minYearTheatersOut">{{ min_year_theaters or 1900 }}</span>
        <br>
        <input type="range" name="max_year_theaters" min="1900" max="2025" value="{{ max_year_theaters or 2025 }}" oninput="document.getElementById('maxYearTheatersOut').textContent = this.value">
        Max: <span id="maxYearTheatersOut">{{ max_year_theaters or 2025 }}</span>
      </div>

      <div class="form-group">
        <label>Release Year (Streaming)</label>
        <input type="range" name="min_year_streaming" min="1990" max="2025" value="{{ min_year_streaming or 1990 }}" oninput="document.getElementById('minYearStreamingOut').textContent = this.value">
        Min: <span id="minYearStreamingOut">{{ min_year_streaming or 1990 }}</span>
        <br>
        <input type="range" name="max_year_streaming" min="1990" max="2025" value="{{ max_year_streaming or 2025 }}" oninput="document.getElementById('maxYearStreamingOut').textContent = this.value">
        Max: <span id="maxYearStreamingOut">{{ max_year_streaming or 2025 }}</span>
      </div>

      <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
    </form>
  </div>

  <!-- Search Results -->
  <div class="col-md-9">
    <h1>Search Results for "{{ query }}"</h1>

    {% if movies %}
    <div class="row">
      {% for movie in movies %}
      <div class="col-md-4 mb-4">
        <div class="card" data-title="{{ movie.title }}">
          <img class="card-img-top poster" src="{{ movie.poster }}" alt="{{ movie.title }}">
          <div class="card-body">
            <h5 class="card-title">{{ movie.title }}</h5>
            <p class="card-text">
              Rotten Tomatoes: {{ movie.tomato_meter if movie.tomato_meter is not none else 'N/A' }}%<br>
              Audience Score: {{ movie.audience_score if movie.audience_score is not none else 'N/A' }}%<br>
              Genre: {{ movie.genre or 'N/A' }}
              Critic Score: {{ movie.avg_critic_score|round(1) if movie.avg_critic_score else 'N/A' }}%<br>
            </p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p>No movies found matching your search.</p>
    {% endif %}

    {% set pag_start = page - 4 if page - 4 > 0 else 1 %}
    {% set pag_end = page + 4 if page + 4 <= total_pages else total_pages %}
    <!-- Pagination -->
    <nav aria-label="Search pagination">
      <ul class="pagination justify-content-start">
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('views.search', q=query, genre=genre, rating=rating, language=language, min_score=min_score, max_score=max_score, page=1) }}">First</a>
        </li>
        {% endif %}
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('views.search', q=query, genre=genre, rating=rating, language=language, min_score=min_score, max_score=max_score, page=page-1) }}">Previous</a>
        </li>
        {% endif %}
        {% for p in range(pag_start, pag_end + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('views.search', q=query, genre=genre, rating=rating, language=language, min_score=min_score, max_score=max_score, page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        {% if page < total_pages %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('views.search', q=query, genre=genre, rating=rating, language=language, min_score=min_score, max_score=max_score, page=page+1) }}">Next</a>
        </li>
        {% endif %}
        {% if page < total_pages %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('views.search', q=query, genre=genre, rating=rating, language=language, min_score=min_score, max_score=max_score, page=total_pages) }}">Last</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.card').forEach(function (card) {
    const title = card.dataset.title;
    const img = card.querySelector('.poster');

    fetch(`/poster/${encodeURIComponent(title)}`)
      .then(res => res.json())
      .then(data => {
        if (data.poster) {
          img.src = data.poster;
        }
      })
      .catch(error => {
        console.error('Error fetching poster:', error);
      });
  });
});
</script>
{% endblock %}